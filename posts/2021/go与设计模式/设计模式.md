# 设计模式

[toc]

## 单例模式

定义：一个类只允许创建一个对象（或者实例），这个类就是单例类，该设计模式叫单例设计模式，简称单例模式。

### 饿汉模式

```go
type logger struct {
    Name string
}

func newLogger(name string) *logger {
    // ... 初始化logger
    return &logger{name}
}

var log = newLogger("default logger")

func getLogger() *logger {
    return log
}
```

### 懒汉模式

```go
type logger struct {
    Name string
}

func newLogger(name string) *logger {
    // ... 初始化logger
    return &logger{name}
}

var log *logger
var m sync.Mutex

func GetLogger() *logger {
    m.Lock()
    if log == nil {
        log = newLogger("default logger")
    }
    m.Unlock()

    return log
}
```

### 饿汉与懒汉兼容

```go
type logger struct {
    Name string
}

func newLogger(name string) *logger {
    // ... 初始化logger
    return &logger{name}
}

var log *logger
var m sync.Mutex

func GetLogger() *logger {
    if log == nil {
        m.Lock()
        if log == nil {
            log = newLogger("hungry&lazy logger")
        }
        m.Unlock()
    }

    return log
}
```

### 优雅实现

```go
type logger struct {
    Name string
}

func newLogger(name string) *logger {
    // ... 初始化logger
    return &logger{name}
}

var log *logger
var once sync.Once

func GetLogger() *logger {
    once.Do(func() {
        log = newLogger("singleton logger")
    })

    return log
}
```

## 工厂模式

### 简单工厂

```go
type Human interface {
    Speak()
}

type HumanType uint

const (
    HumanTypeChinese HumanType = iota
    HumanTypeJapanese
    HumanTypeAmerican
)

type Chinese struct {
}

func (c Chinese) Speak() {
    fmt.Println("I speak Chinese")
}

type Japanese struct {
}

func (j Japanese) Speak() {
    fmt.Println("I speak Japanese")
}

type American struct {
}

func (a American) Speak() {
    fmt.Println("I speak American English")
}

type HumanFactory struct {
}

func (f HumanFactory) ProduceHuman(humanType HumanType) Human {
    if humanType == HumanTypeChinese {
        return &Chinese{}
    } else if humanType == HumanTypeJapanese {
        return &Japanese{}
    } else if humanType == HumanTypeAmerican {
        return &American{}
    } else {
        return nil
    }
}
```

### 工厂方法

```go
type Human interface {
    Speak()
}

type HumanType uint
type HumanFactory func() Human

const (
    HumanTypeChinese HumanType = iota
    HumanTypeJapanese
    HumanTypeAmerican
)

type Chinese struct {
}

func (c Chinese) Speak() {
    fmt.Println("I speak Chinese")
}

func produceChinese() Human {
    return &Chinese{}
}

type Japanese struct {
}

func (j Japanese) Speak() {
    fmt.Println("I speak Japanese")
}

func produceJapanese() Human {
    return &Japanese{}
}

type American struct {
}

func (a American) Speak() {
    fmt.Println("I speak American English")
}

func produceAmerican() Human {
    return &American{}
}

var humanFactoryGenMap = map[HumanType]HumanFactory{
    HumanTypeChinese:  produceChinese,
    HumanTypeJapanese: produceJapanese,
    HumanTypeAmerican: produceAmerican,
}

func GetHumanFactory(humanType HumanType) HumanFactory {
    if h, ok := humanFactoryGenMap[humanType]; ok {
        return h
    }

    return nil
}

func HumanSpeak(humanType HumanType) {
    humanFactory := GetHumanFactory(humanType)
    if humanFactory == nil {
        return
    }

    human := humanFactory()
    human.Speak()
}
```

## 建造者模式

使用场景：当实例化对象的时候参数比较多，且参数之间存在依赖时可以考虑使用建造者模式。

```go
const (
    defaultMaxTotal = 10
    defaultMaxIdle  = 5
)

type ResourcePoolConfig struct {
    name     string
    maxTotal uint
    maxIdle  uint
    minIdle  uint
}

func newResourcePoolConfig(build *resourcePoolBuilder) *ResourcePoolConfig {
    return &ResourcePoolConfig{
        name:     build.name,
        maxTotal: build.maxTotal,
        maxIdle:  build.maxIdle,
        minIdle:  build.minIdle,
    }
}

type resourcePoolBuilder struct {
    name     string // 必填
    maxTotal uint   // 必填
    maxIdle  uint   // 必填
    minIdle  uint   // 选填
}

func NewResourcePoolBuilder() *resourcePoolBuilder {
    return &resourcePoolBuilder{
        maxTotal: defaultMaxTotal,
        maxIdle:  defaultMaxIdle,
    }
}

func (builder *resourcePoolBuilder) Build() (*ResourcePoolConfig, error) {
    if builder.name == "" {
        return nil, errors.New("name不能为空")
    }

    if builder.maxTotal == 0 {
        return nil, errors.New("maxTotal不能0")
    }

    if builder.maxIdle == 0 {
        return nil, errors.New("maxIdle不能0")
    }

    if builder.minIdle > builder.maxIdle {
        return nil, errors.New("minIdle不能大于maxIdle")
    }

    return newResourcePoolConfig(builder), nil
}

func (builder *resourcePoolBuilder) SetName(name string) *resourcePoolBuilder {
    builder.name = name
    return builder
}

func (builder *resourcePoolBuilder) SetMaxTotal(maxTotal uint) *resourcePoolBuilder {
    builder.maxTotal = maxTotal
    return builder
}

func (builder *resourcePoolBuilder) SetMaxIdle(maxIdle uint) *resourcePoolBuilder {
    builder.maxIdle = maxIdle
    return builder
}

func (builder *resourcePoolBuilder) SetMinIdle(minIdle uint) *resourcePoolBuilder {
    builder.minIdle = minIdle
    return builder
}
```

使用示例：

```go
func GetMysqlResourceConfig() (*ResourcePoolConfig,error) {
    resourceConfig, err := NewResourcePoolBuilder().
        SetName("mysql_pool_config").
        SetMaxTotal(50).
        SetMaxIdle(10).
        SetMinIdle(5).
        Build()
    if err != nil {
        return nil, err
    }
    
    return resourceConfig, nil
}
```

