# 网络通信过程
## 相同网段的两台机器通信过程
A机器：192.168.26.129/24  
B机器：192.168.26.3/24  

这时如果A去ping B，过程如下：
1. A发现与B在同一个网段下，于是A会发起一个ARP广播，询问同一个网络地址下的所有主机，192.168.26.3这个ip是谁的，它的mac地址是什么。
2. B收到ARP广播时，发现自己的ip就是192.168.26.3，将A的mac地址写入自己的ARP缓存，并且向A发送一个ARP应答单播。
3. A收到了B的mac地址，于是分装成完整的数据帧发送到B，包中包含自己ip和目的地ip，自己的mac地址和目的地mac地址。同时A会将B的mac地址记录在自己的缓存中以备下次使用。
4. B收到了A的ping包，已经具有了双方的ip和mac地址，可以直接进行通信。

## 不同网段的两台机器通信过程
A机器：192.168.26.129/24  
B机器：192.168.25.3/24 
默认网关：192.168.26.2 

这时如果A去ping B，过程如下：
1. A发现与B在不同一个网段下，无法直接通信，只能通过路由器转发。A会发出一个ARP广播，查询默认网关192.168.26.2的mac地址。
2. 默认网关回复自己mac地址给A，A使用默认网关的ip和mac地址发送ping包，于是便间接转化成路由器和B之间的通信
3. 默认网关如果没有B的mac地址，也会发起一个ARP广播查询B的mac地址，B回复Mac地址给默认网关，默认网关缓存B的mac地址以便之后不用重复查询。
4. 默认网关可以与B通信。

即：  
A主机 <----> 默认网关 <----> B主机

# 为什么ip和mac地址都缺一不可
举个常用的例子，A和B在课堂上想要传小纸条，无奈两人相隔较远，纸条无法直接被递到。  
这时便需要邻座的同学帮忙了，我们在小纸条写上，“我是A，请帮我把这张纸条传递给B”。领座收到纸条发现自己和B还有点距离，于是看了下四周，找了个距离B最近的领座再传递下去，纸条最终到达B，而B看到纸条写着A的名字，也知道了这个纸条是A给他的。

在这个过程中，A代表发送方ip，B代表接收方ip，每个同学的胳膊就是mac地址，这个过程中mac地址一直在变化，这里的每个mac地址对应的设备就是网关。

mac地址相当于给每个设备都设定了一个唯一标识符，它没有任何含义  
而ip，我们知道它被分为网络地址和主机地址，可以做到区域性，例如这批ip可以就属于这部分区域，当然也具备一些特点。

回归到上述例子，如果A和B都用mac地址，第一个接收A纸条的领座同学是C，他记录了A坐在方位1。这时A同学有一天突然换了位置，纸条也给了C，他还得知道A坐到了方位2。长期以往，C同学的记录表会越来越大。

对应到网络世界道理也是一样的，每个路由器都去记录全世界的mac地址肯定是不可取的。

具体可以参考 [为什么MAC地址之外需要IP地址？](http://www.i-makers.info/blog/144.html)
